<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>WhatsApp Pro - Global</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <style>
        :root { --wa-bg: #0b141a; --wa-panel: #202c33; --wa-green: #00a884; }
        body { background-color: var(--wa-bg); color: #e9edef; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        
        /* Glassmorphism & Animations */
        .glass { background: rgba(32, 44, 51, 0.95); backdrop-filter: blur(10px); }
        .msg-in { background: #202c33; border-radius: 0 12px 12px 12px; align-self: flex-start; position: relative; }
        .msg-out { background: #005c4b; border-radius: 12px 0 12px 12px; align-self: flex-end; position: relative; }
        .chat-pattern { background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png'); opacity: 0.06; position: absolute; inset: 0; pointer-events: none; }
        
        @keyframes slideIn { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .animate-msg { animation: slideIn 0.3s ease-out forwards; }
        
        /* Call Pulse */
        .pulse-green { animation: pulse 2s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(0, 168, 132, 0.4); } 70% { box-shadow: 0 0 0 20px rgba(0, 168, 132, 0); } 100% { box-shadow: 0 0 0 0 rgba(0, 168, 132, 0); } }
    </style>
</head>
<body class="h-screen overflow-hidden flex flex-col items-center">

    <div id="loginScreen" class="fixed inset-0 z-[2000] bg-[#0b141a] flex flex-col items-center justify-center p-10">
        <div class="w-24 h-24 bg-[#00a884] rounded-[2rem] flex items-center justify-center text-5xl mb-6 shadow-2xl">üì±</div>
        <h1 class="text-2xl font-bold mb-2">WhatsApp Pro</h1>
        <p class="text-gray-500 text-sm mb-10 text-center">End-to-end encrypted global connection</p>
        <input type="text" id="nameInput" placeholder="Enter your name" class="w-full max-w-xs p-4 rounded-2xl bg-[#2a3942] border-none outline-none text-center font-bold mb-4 focus:ring-2 focus:ring-[#00a884] transition-all">
        <button onclick="startApp()" class="w-full max-w-xs bg-[#00a884] p-4 rounded-2xl font-bold tracking-widest hover:bg-[#06cf9c] transition-all">AGREE & CONTINUE</button>
    </div>

    <div id="homeScreen" class="hidden w-full max-w-md h-full flex flex-col bg-[#0b141a] border-x border-white/5 relative">
        <header class="p-5 flex justify-between items-center bg-[#202c33] sticky top-0 z-50">
            <h1 class="text-xl font-bold text-gray-100">WhatsApp</h1>
            <div class="flex gap-4 items-center">
                <span id="onlineBadge" class="w-3 h-3 bg-red-500 rounded-full"></span>
                <button onclick="location.reload()" class="text-gray-400">‚Üª</button>
            </div>
        </header>
        
        <div id="usersList" class="flex-1 overflow-y-auto p-4 space-y-3">
            <p class="text-center text-gray-500 mt-20 italic">Searching for global signals...</p>
        </div>
    </div>

    <div id="chatRoom" class="hidden fixed inset-0 z-[1000] bg-[#0b141a] flex flex-col">
        <header class="p-3 bg-[#202c33] flex items-center gap-3 shadow-xl">
            <button onclick="closeChat()" class="p-2 text-[#00a884] text-xl">‚Üê</button>
            <div class="w-10 h-10 bg-gray-600 rounded-full flex items-center justify-center font-bold" id="chatTitleIcon">?</div>
            <div class="flex-1">
                <h2 id="chatTitleName" class="font-bold text-sm">Target</h2>
                <p class="text-[10px] text-[#00a884] font-bold">ONLINE</p>
            </div>
            <button onclick="initCall(false)" class="p-2 text-[#00a884]">üìû</button>
            <button onclick="initCall(true)" class="p-2 text-[#00a884]">üìπ</button>
        </header>
        <div class="flex-1 relative overflow-hidden flex flex-col">
            <div class="chat-pattern"></div>
            <div id="messagesList" class="flex-1 overflow-y-auto p-4 flex flex-col gap-3 z-10"></div>
        </div>
        <div class="p-3 bg-[#202c33] flex items-center gap-2 z-20">
            <input type="text" id="msgInput" placeholder="Type a message" class="flex-1 bg-[#2a3942] p-3 rounded-full outline-none px-5 text-sm">
            <button onclick="triggerSend()" class="bg-[#00a884] w-12 h-12 rounded-full flex items-center justify-center text-white shadow-lg">‚û§</button>
        </div>
    </div>

    <div id="callOverlay" class="hidden fixed inset-0 z-[3000] bg-black flex flex-col items-center justify-between py-20">
        <div class="text-center">
            <div class="w-24 h-24 bg-gray-700 rounded-full mx-auto mb-4 flex items-center justify-center text-4xl" id="callAvatar">?</div>
            <h2 id="callStatusName" class="text-2xl font-bold">Calling...</h2>
            <p id="callTimer" class="text-[#00a884] font-bold mt-2">Connecting...</p>
        </div>
        
        <video id="remoteVideo" autoplay playsinline class="absolute inset-0 w-full h-full object-cover hidden"></video>
        <video id="localVideo" autoplay playsinline muted class="absolute bottom-32 right-6 w-32 h-44 rounded-2xl border-2 border-[#00a884] object-cover hidden shadow-2xl"></video>

        <div class="z-50 flex gap-10">
            <button onclick="location.reload()" class="bg-red-600 w-16 h-16 rounded-full flex items-center justify-center text-2xl shadow-xl">üìµ</button>
            <button id="answerBtn" onclick="acceptIncoming()" class="hidden bg-green-500 w-16 h-16 rounded-full flex items-center justify-center text-2xl shadow-xl pulse-green">üìû</button>
        </div>
    </div>

    <script>
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwZfhQSp76NOGXYSM2qAZaVjbI-doX-M7BymT5NkKGcQJSvzt0SEntwmhfn6oPjvhA/exec';
        
        // Critical: Global Relay Servers (WebRTC Fix)
        const PEER_CONFIG = {
            config: {
                'iceServers': [
                    { 'urls': 'stun:stun.l.google.com:19302' },
                    { 'urls': 'stun:stun1.l.google.com:19302' },
                    { 'urls': 'stun:stun2.l.google.com:19302' }
                ]
            }
        };

        let peer, myId, myName, currentChat, activeCall, localStream, msgCount = 0;

        // Start App
        function startApp() {
            myName = document.getElementById('nameInput').value.trim();
            if(!myName) return alert("Please enter your name!");
            localStorage.setItem('wa_name', myName);
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('homeScreen').classList.remove('hidden');
            
            initPeer();
        }

        // Initialize Peer with Global ID
        function initPeer() {
            peer = new Peer(PEER_CONFIG);
            
            peer.on('open', id => {
                myId = id;
                document.getElementById('onlineBadge').style.backgroundColor = '#00a884';
                updatePresence();
                setInterval(updatePresence, 8000); // 8 sec heartbeat
                setInterval(refreshUserList, 5000);
            });

            // Handle Incoming Call
            peer.on('call', call => {
                activeCall = call;
                showCallUI(true, "Incoming Call...");
                new Audio('https://assets.mixkit.co/active_storage/sfx/1359/1359-preview.mp3').play();
            });
        }

        async function updatePresence() {
            await fetch(`${SCRIPT_URL}?action=addUser&name=${encodeURIComponent(myName)}&peerId=${myId}`);
        }

        async function refreshUserList() {
            const res = await fetch(`${SCRIPT_URL}?action=getUsers`);
            const users = await res.json();
            const list = document.getElementById('usersList');
            list.innerHTML = '';
            
            users.forEach(u => {
                if(u.peerId === myId) return;
                list.innerHTML += `
                    <div class="bg-[#202c33] p-4 rounded-2xl flex items-center gap-4 transition-all active:scale-95" onclick="openChat('${u.name}', '${u.peerId}')">
                        <div class="w-12 h-12 bg-[#00a884] rounded-full flex items-center justify-center font-bold text-lg">${u.name[0]}</div>
                        <div class="flex-1">
                            <h3 class="font-bold">${u.name}</h3>
                            <p class="text-[10px] text-[#00a884] font-bold tracking-widest uppercase">Tap to chat & call</p>
                        </div>
                    </div>`;
            });
            if(currentChat) fetchMessages();
        }

        // --- Chat Logic ---
        function openChat(name, id) {
            currentChat = { name, id };
            document.getElementById('chatTitleName').innerText = name;
            document.getElementById('chatTitleIcon').innerText = name[0];
            document.getElementById('chatRoom').classList.remove('hidden');
            msgCount = 0;
            fetchMessages();
        }

        function closeChat() { document.getElementById('chatRoom').classList.add('hidden'); currentChat = null; }

        async function triggerSend() {
            const inp = document.getElementById('msgInput');
            const msg = inp.value.trim();
            if(!msg) return;
            inp.value = "";
            await fetch(`${SCRIPT_URL}?action=sendSMS&from=${encodeURIComponent(myName)}&to=${encodeURIComponent(currentChat.name)}&msg=${encodeURIComponent(msg)}`);
            fetchMessages();
        }

        async function fetchMessages() {
            if(!currentChat) return;
            const res = await fetch(`${SCRIPT_URL}?action=getSMS&myName=${encodeURIComponent(myName)}&target=${encodeURIComponent(currentChat.name)}`);
            const msgs = await res.json();
            
            if(msgs.length > msgCount) {
                const list = document.getElementById('messagesList');
                list.innerHTML = '';
                msgs.forEach(m => {
                    const isOut = (m.from === myName);
                    list.innerHTML += `<div class="${isOut ? 'msg-out' : 'msg-in'} p-3 max-w-[80%] text-sm animate-msg shadow-md">
                        ${m.msg}
                    </div>`;
                });
                list.scrollTop = list.scrollHeight;
                if(msgCount !== 0 && msgs[msgs.length-1].from !== myName) {
                    new Audio('https://assets.mixkit.co/active_storage/sfx/2358/2358-preview.mp3').play();
                }
                msgCount = msgs.length;
            }
        }

        // --- Global Video Call Logic ---
        async function initCall(isVideo) {
            showCallUI(false, `Calling ${currentChat.name}...`);
            try {
                localStream = await navigator.mediaDevices.getUserMedia({video: isVideo, audio: true});
                if(isVideo) {
                    document.getElementById('localVideo').srcObject = localStream;
                    document.getElementById('localVideo').classList.remove('hidden');
                }
                
                const call = peer.call(currentChat.id, localStream);
                handleCallStream(call, isVideo);
            } catch(e) { alert("Camera/Mic Permission Denied!"); location.reload(); }
        }

        async function acceptIncoming() {
            document.getElementById('answerBtn').classList.add('hidden');
            try {
                localStream = await navigator.mediaDevices.getUserMedia({video: true, audio: true});
                document.getElementById('localVideo').srcObject = localStream;
                document.getElementById('localVideo').classList.remove('hidden');
                
                activeCall.answer(localStream);
                handleCallStream(activeCall, true);
            } catch(e) { alert("Camera Access Error"); }
        }

        function handleCallStream(call, isVideo) {
            call.on('stream', rs => {
                const rv = document.getElementById('remoteVideo');
                rv.srcObject = rs;
                rv.classList.remove('hidden');
                document.getElementById('callTimer').innerText = "00:01 (Connected)";
            });
        }

        function showCallUI(isIncoming, status) {
            document.getElementById('callOverlay').classList.remove('hidden');
            document.getElementById('callStatusName').innerText = status;
            if(isIncoming) document.getElementById('answerBtn').classList.remove('hidden');
        }
    </script>
</body>
</html>
